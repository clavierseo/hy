<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹ ë‚˜ëŠ” 3D ë¬¼ê° ë†€ì´!</title>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Jua', cursive; touch-action: none; user-select: none; }

        /* UI ì»¨í…Œì´ë„ˆ: ë” ì¥ë‚œê° ê°™ê³  ë‘¥ê¸€ê²Œ */
        #ui-container { 
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); 
            width: 92%; max-width: 680px; 
            background: rgba(255, 255, 255, 0.85); 
            padding: 20px 15px; border-radius: 35px; 
            box-shadow: 0 10px 30px rgba(0,100,200,0.2);
            display: flex; flex-direction: column; align-items: center; z-index: 100;
            border: 5px solid #FFD700; /* ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ */
        }

        /* ì•ˆë‚´ ë¬¸êµ¬ */
        .info { font-size: 1.4rem; color: #333; text-align: center; margin-bottom: 15px; text-shadow: 1px 1px 2px white; }
        .highlight { color: #FF4500; font-weight: bold; }

        /* íŒ”ë ˆíŠ¸ ì˜ì—­ */
        .palette { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 15px; }
        
        /* ë¬¼ê° ë²„íŠ¼: í¬ê³  ì ¤ë¦¬ì²˜ëŸ¼ */
        .color-drop { 
            width: 45px; height: 45px; border-radius: 50%; 
            border: 4px solid white; 
            cursor: pointer; box-shadow: 0 5px 10px rgba(0,0,0,0.1); 
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* íŒ…ê¸°ëŠ” íš¨ê³¼ */
            box-sizing: border-box;
        }
        .color-drop:active { transform: scale(0.9); } /* ëˆ„ë¥¼ ë•Œ ì‘ì•„ì§ */
        .color-drop.active { border-color: #FFD700; transform: scale(1.15); box-shadow: 0 0 15px #FFD700; }
        
        /* ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼: í¬ê³  ë¹¨ê°„ ë²„íŠ¼ */
        .reset-all-btn { 
            background-color: #FF6347; color: white; border: none; 
            padding: 12px 30px; border-radius: 25px; font-size: 1.2rem;
            cursor: pointer; font-family: 'Jua', cursive;
            box-shadow: 0 5px #c0392b; transition: all 0.1s;
        }
        .reset-all-btn:active { transform: translateY(4px); box-shadow: 0 1px #c0392b; }

        /* ë¹„ì»¤ë³„ ì •ë³´ ë° ë¦¬ì…‹ ë²„íŠ¼ (ì•„ì´ì½˜í™”) */
        .beaker-label { 
            position: absolute; font-size: 14px; color: #333; text-align: center; font-weight: bold;
            bottom: -25px; width: 120px; pointer-events: none; opacity: 0.8;
            transform: translateX(-50%) translateY(-55px); text-shadow: 1px 1px 1px white;
        }
        .beaker-reset-btn {
            position: absolute; bottom: -55px; width: 20px; height: 20px;
            background-color: #87CEFA; color: white; border: 3px solid white; border-radius: 50%;
            cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2); transition: transform 0.1s;
            transform: translateX(-50%) translateY(-145px); opacity: 0.9;
        }
        .beaker-reset-btn:active { transform: translateX(-50%) scale(0.9); background-color: #FF6347;}
        .beaker-group:hover .beaker-label, .beaker-group:hover .beaker-reset-btn { opacity: 1; }

    </style>
</head>
<body>

<audio id="sfx-pop" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.m4a"></audio>
<audio id="sfx-splash" src="https://assets.mixkit.co/active_storage/sfx/112/112-preview.m4a"></audio>
<audio id="sfx-whoosh" src="https://assets.mixkit.co/active_storage/sfx/1472/1472-preview.m4a"></audio>


<div id="ui-container">
    <div class="info" id="status">ì›í•˜ëŠ” ìƒ‰ê¹”ì„ <span class="highlight">ì½•!</span> ì„ íƒí•´ë´! í•˜ìœ¤!</div>
    <div class="palette" id="palette"></div>
    <button class="reset-all-btn" id="resetAllBtn">âœ¨ ëª¨ë‘ ê¹¨ë—í•˜ê²Œ ë¹„ìš°ê¸° âœ¨</button>
</div>

<script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- íš¨ê³¼ìŒ í”Œë ˆì´ì–´ ---
    const sfxPop = document.getElementById('sfx-pop');
    const sfxSplash = document.getElementById('sfx-splash');
    const sfxWhoosh = document.getElementById('sfx-whoosh');
    sfxSplash.volume = 0.6; // ë¬¼ì†Œë¦¬ ë³¼ë¥¨ ì¡°ì ˆ

    function playSound(sound) {
        sound.currentTime = 0;
        sound.play().catch(() => {}); // ìë™ ì¬ìƒ ì°¨ë‹¨ ì˜ˆì™¸ ì²˜ë¦¬
    }

    // --- ì—”ì§„ ì„¤ì • (ë°ê³  í™”ì‚¬í•˜ê²Œ) ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); // í•˜ëŠ˜ìƒ‰ ë°°ê²½
    scene.fog = new THREE.FogExp2(0x87CEEB, 0.02); // ë¶€ë“œëŸ¬ìš´ ì•ˆê°œ

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 7, 18); 

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // ëª¨ë°”ì¼ ìµœì í™”
    renderer.shadowMap.enabled = true; // ê·¸ë¦¼ì ì¼œê¸°
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.maxPolarAngle = Math.PI / 1.7;
    controls.minDistance = 8;
    controls.maxDistance = 30;
    // controls.autoRotate = true; controls.autoRotateSpeed = 0.5; // ì‚´ì§ ìë™ íšŒì „ (ì„ íƒ)

    // --- ì¡°ëª… (ë”°ëœ»í•˜ê³  ë°ì€ í–‡ì‚´) ---
    scene.add(new THREE.AmbientLight(0xffffff, 0.7)); 

    const sunLight = new THREE.DirectionalLight(0xFFD700, 1.2); // ë”°ëœ»í•œ í–‡ì‚´
    sunLight.position.set(10, 20, 10);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.width = 2048;
    sunLight.shadow.mapSize.height = 2048;
    scene.add(sunLight);

    const skyLight = new THREE.HemisphereLight(0xffffff, 0x87CEEB, 0.6);
    scene.add(skyLight);

    // --- í™˜ê²½ (ë™í™” ê°™ì€ ë™ì‚°) ---
    // ë°”ë‹¥ (ì”ë”” ëŠë‚Œ)
    const planeGeo = new THREE.PlaneGeometry(200, 200);
    const planeMat = new THREE.MeshStandardMaterial({ color: 0x90EE90, roughness: 0.9 });
    const plane = new THREE.Mesh(planeGeo, planeMat);
    plane.rotation.x = -Math.PI / 2;
    plane.position.y = -4;
    plane.receiveShadow = true;
    scene.add(plane);

    // ì„ ë°˜ (ë‚˜ë¬´ ëŠë‚Œ)
    function createShelf(y) {
        const geo = new THREE.BoxGeometry(17, 0.4, 4);
        const mat = new THREE.MeshStandardMaterial({ color: 0xDEB887, roughness: 0.6 });
        const shelf = new THREE.Mesh(geo, mat);
        shelf.position.y = y - 1.5;
        shelf.receiveShadow = true;
        shelf.castShadow = true;
        scene.add(shelf);
    }
    createShelf(0); 
    createShelf(5); 

    // --- ë³€ìˆ˜ ë° ë°ì´í„° ---
    let selectedColorData = null;
    const beakers = [];
    // ë” ë°ê³  ì„ ëª…í•œ 16ìƒ‰ íŒ”ë ˆíŠ¸
    const colors = [
        {r:255, g:0, b:0}, {r:255, g:165, b:0}, {r:255, g:255, b:0}, {r:50, g:205, b:50},
        {r:0, g:191, b:255}, {r:0, g:0, b:255}, {r:138, g:43, b:226}, {r:255, g:20, b:147},
        {r:255, g:105, b:180}, {r:0, g:255, b:255}, {r:124, g:252, b:0}, {r:255, g:215, b:0},
        {r:255, g:127, b:80}, {r:186, g:85, b:211}, {r:64, g:224, b:208}, {r:255, g:99, b:71}
    ];
    const MAX_DROPS = 100;

    // --- ë¹„ì»¤ ì¬ì§ˆ (íˆ¬ëª…í•˜ê³  ë°˜ì§ì´ê²Œ) ---
    const glassMaterial = new THREE.MeshPhongMaterial({
        color: 0xffffff, opacity: 0.15, transparent: true, shininess: 100,
        side: THREE.DoubleSide, depthWrite: false
    });
    const rimMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.5 }); 

    // --- ë¹„ì»¤ ìƒì„± ---
    const beakerBodyGeo = new THREE.CylinderGeometry(1, 0.95, 3, 32, 1, true);
    const beakerBottomGeo = new THREE.CircleGeometry(0.95, 32);
    const rimGeo = new THREE.TorusGeometry(1.0, 0.04, 16, 48);

    for (let i = 0; i < 10; i++) {
        const beakerGroup = new THREE.Group();
        beakerGroup.add(new THREE.Mesh(beakerBodyGeo, glassMaterial));
        const bottom = new THREE.Mesh(beakerBottomGeo, glassMaterial);
        bottom.rotation.x = -Math.PI / 2; bottom.position.y = -1.5; beakerGroup.add(bottom);
        const topRim = new THREE.Mesh(rimGeo, rimMaterial);
        topRim.rotation.x = Math.PI / 2; topRim.position.y = 1.5; beakerGroup.add(topRim);
        const bottomRim = new THREE.Mesh(rimGeo, rimMaterial);
        bottomRim.rotation.x = Math.PI / 2; bottomRim.position.y = -1.5; bottomRim.scale.set(0.95, 0.95, 1); beakerGroup.add(bottomRim);

        // ë‚´ë¶€ ì•¡ì²´ (ìŠ¤ìŠ¤ë¡œ ë¹›ë‚˜ê²Œ Emissive ì¶”ê°€)
        const liqGeo = new THREE.CylinderGeometry(0.92, 0.88, 2.9, 32);
        liqGeo.translate(0, 1.45, 0); 
        const liqMat = new THREE.MeshStandardMaterial({ 
            color: 0xffffff, transparent: true, opacity: 0, roughness: 0.1,
            emissive: 0x000000, emissiveIntensity: 0.4
        });
        const liquid = new THREE.Mesh(liqGeo, liqMat);
        liquid.position.y = -1.45; liquid.scale.y = 0.001; 
        beakerGroup.add(liquid);

        // UI ìš”ì†Œ (ë¼ë²¨ ë° ì“°ë ˆê¸°í†µ ë²„íŠ¼)
        const labelDiv = document.createElement('div');
        labelDiv.className = 'beaker-label beaker-group';
        labelDiv.innerText = `í…… ë¹„ì—ˆìŒ`;
        document.body.appendChild(labelDiv); 

        const resetButton = document.createElement('button');
        resetButton.className = 'beaker-reset-btn beaker-group';
        resetButton.innerHTML = 'ğŸ—‘ï¸'; // ì“°ë ˆê¸°í†µ ì´ëª¨ì§€
        resetButton.onclick = (e) => {
             e.stopPropagation(); 
             playSound(sfxWhoosh); // ë¹„ìš°ê¸° ì†Œë¦¬
             resetBeaker(beakerGroup);
        };
        document.body.appendChild(resetButton); 

        // ë°°ì¹˜
        const isTopRow = i >= 5; const col = i % 5;
        beakerGroup.position.x = (col - 2) * 3.2;
        beakerGroup.position.y = isTopRow ? 5 : 0;
        beakerGroup.castShadow = true;
        
        // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì´ˆê¸° íšŒì „ê°’ ì €ì¥
        beakerGroup.userData = { 
            id: i, drops: [], liquidMesh: liquid, labelDiv: labelDiv, resetButton: resetButton,
            initialRotation: beakerGroup.rotation.clone(),
            wobbleNeed: false
        };
        scene.add(beakerGroup);
        beakers.push(beakerGroup);
        updateBeakerUIPosition(beakerGroup);
    }

    function updateBeakerUIPosition(beakerGroup) {
        const vector = new THREE.Vector3();
        beakerGroup.localToWorld(vector.set(0, -1.8, 0)); 
        vector.project(camera); 
        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
        beakerGroup.userData.labelDiv.style.left = `${x}px`; beakerGroup.userData.labelDiv.style.top = `${y}px`;
        beakerGroup.userData.resetButton.style.left = `${x}px`; beakerGroup.userData.resetButton.style.top = `${y}px`;
    }

    // --- ìƒ‰ìƒ ì„ê¸° ì—”ì§„ ---
    function getMixedColor(drops) {
        if (drops.length === 0) return { r: 1, g: 1, b: 1, a: 0 }; 
        let c=0, m=0, y=0, k=0, waterCount=0, colorCount=0;
        drops.forEach(d => {
            if (d.isWater) waterCount++;
            else {
                let r=d.r/255, g=d.g/255, b=d.b/255, kk=1-Math.max(r,g,b);
                c+=(1-r-kk)/(1-kk||1); m+=(1-g-kk)/(1-kk||1); y+=(1-b-kk)/(1-kk||1); k+=kk; colorCount++;
            }
        });
        if (drops.length === 0) return { r:1, g:1, b:1, a:0 };
        const avgC=colorCount>0?c/colorCount:0, avgM=colorCount>0?m/colorCount:0, avgY=colorCount>0?y/colorCount:0, avgK=colorCount>0?k/colorCount:0;
        let fR=(1-avgC)*(1-avgK), fG=(1-avgM)*(1-avgK), fB=(1-avgY)*(1-avgK);
        const wInf = waterCount/drops.length;
        fR+= (1-fR)*wInf*0.6; fG+= (1-fG)*wInf*0.6; fB+= (1-fB)*wInf*0.6;
        const op = Math.min(0.85 + (colorCount/drops.length)*0.13, 0.98);
        return { r:fR, g:fG, b:fB, a:op };
    }

    function resetBeaker(beakerGroup) {
        const data = beakerGroup.userData;
        data.drops = [];
        data.liquidMesh.material.color.setRGB(1, 1, 1);
        data.liquidMesh.material.emissive.setHex(0x000000);
        data.liquidMesh.material.opacity = 0;
        data.liquidMesh.scale.y = 0.001;
        data.labelDiv.innerText = `í…… ë¹„ì—ˆìŒ`;
        status.innerHTML = "ê¹¨ë—í•´ì¡Œë‹¤! ë‹¤ì‹œ ì‹œì‘í•´ë³¼ê¹Œ? âœ¨";
    }

    document.getElementById('resetAllBtn').onclick = () => {
        playSound(sfxWhoosh);
        beakers.forEach(b => resetBeaker(b));
        status.innerHTML = "ëª¨ë‘ ë‹¤ ê¹¨ë—í•˜ê²Œ! ë°˜ì§ë°˜ì§! âœ¨í•˜ìœ¤!"   ;
    };

    // --- UI ë° ìƒí˜¸ì‘ìš© ---
    const palette = document.getElementById('palette');
    const status = document.getElementById('status');

    function createColorBtn(col, isWater = false) {
        const btn = document.createElement('div');
        btn.className = 'color-drop';
        btn.style.backgroundColor = `rgb(${col.r},${col.g},${col.b})`;
        if (isWater) btn.style.background = 'radial-gradient(circle at 30% 30%, #ffffff, #87CEFA)';
        btn.onpointerdown = () => {
            playSound(sfxPop); // íŒ ì†Œë¦¬
            document.querySelectorAll('.color-drop').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedColorData = { ...col, isWater };
            status.innerHTML = isWater ? "íˆ¬ëª…í•œ <span class='highlight' style='color:#87CEFA'>ë¬¼</span> ì„ íƒ! ìƒ‰ì´ ì—°í•´ì§ˆ ê±°ì•¼." : "ì´ì œ ë¹„ì»¤ì— <span class='highlight'>ì²¨ë²™!</span> ë„£ì–´ë´!";
        };
        palette.appendChild(btn);
    }

    colors.forEach(c => createColorBtn(c));
    createColorBtn({r:255, g:255, b:255}, true); 

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    window.addEventListener('pointerdown', (e) => {
        if (e.target.closest('#ui-container') || e.target.closest('.beaker-reset-btn')) return;
        if (!selectedColorData) {
            status.innerHTML = "ë¨¼ì € <span class='highlight'>ìƒ‰ê¹” ë²„íŠ¼</span>ì„ ëˆŒëŸ¬ì¤˜!"; 
            return;
        }

        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(beakers, true);
        if (intersects.length > 0) {
            let targetGroup = intersects[0].object;
            while(targetGroup && !targetGroup.userData.drops) targetGroup = targetGroup.parent;

            if (targetGroup && targetGroup.userData.drops) {
                const data = targetGroup.userData;
                if (data.drops.length < MAX_DROPS) {
                    playSound(sfxSplash); // ì²¨ë²™ ì†Œë¦¬
                    // ë¹„ì»¤ í”ë“¤ë¦¼ íš¨ê³¼ ì‹œì‘
                    data.wobbleNeed = true; wobbleStartTime = Date.now();

                    data.drops.push({ ...selectedColorData });
                    const mixed = getMixedColor(data.drops);
                    data.liquidMesh.material.color.setRGB(mixed.r, mixed.g, mixed.b);
                    data.liquidMesh.material.emissive.setRGB(mixed.r*0.5, mixed.g*0.5, mixed.b*0.5);
                    data.liquidMesh.material.opacity = mixed.a;
                    data.liquidMesh.scale.y = data.drops.length / MAX_DROPS;
                    data.labelDiv.innerText = `${data.drops.length} ë°©ìš¸!`;
                    status.innerHTML = `ì˜í–ˆì–´! <span class='highlight'>${data.drops.length}ë°©ìš¸</span> ì„ì—ˆë„¤!`;
                } else {
                    status.innerHTML = "ì–´ë¼? ë¹„ì»¤ê°€ ê½‰ ì°¼ë„¤! ğŸ˜² ë¹„ìš°ê³  ë‹¤ì‹œ í•˜ì!";
                }
            }
        }
    });

    // --- ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ (ë¹„ì»¤ í”ë“¤ë¦¼ ì¶”ê°€) ---
    let wobbleStartTime = 0;
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        
        // ë¹„ì»¤ í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬
        const now = Date.now();
        beakers.forEach(b => {
            if(b.userData.wobbleNeed) {
                const elapsed = now - wobbleStartTime;
                if (elapsed < 300) { // 0.3ì´ˆ ë™ì•ˆ í”ë“¤ë¦¼
                    const intensity = 0.05 * (1 - elapsed / 300);
                    b.rotation.x = b.userData.initialRotation.x + Math.sin(elapsed * 0.05) * intensity;
                    b.rotation.z = b.userData.initialRotation.z + Math.cos(elapsed * 0.05) * intensity;
                } else {
                    b.rotation.copy(b.userData.initialRotation); // ì›ìœ„ì¹˜
                    b.userData.wobbleNeed = false;
                }
            }
            updateBeakerUIPosition(b);
        });

        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
