<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§„ì§œ ë¬¼ê° ìƒ‰ê¹” ë†€ì´</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Jua', cursive; touch-action: none; user-select: none; }

        /* UI ì»¨í…Œì´ë„ˆ */
        #ui-container { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95); 
            padding: 15px 0 35px 0; 
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center; z-index: 100;
            border-top: 6px solid #FFD700;
        }

        .info { font-size: 1.2rem; color: #333; margin-bottom: 12px; text-align: center; }
        .highlight { color: #FF4500; font-weight: bold; }

        /* íŒ”ë ˆíŠ¸ */
        .palette { 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            gap: 8px; 
            width: 94%; max-width: 480px; 
            justify-items: center;
            margin-bottom: 10px;
        }
        
        /* ë¬¼ê° ë²„íŠ¼ */
        .color-drop { 
            width: 100%; aspect-ratio: 1; 
            max-width: 45px; 
            border-radius: 50%; 
            border: 2px solid #fff; 
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.25); 
            box-sizing: border-box;
            transition: transform 0.1s;
        }
        .color-drop:active { transform: scale(0.8); }
        .color-drop.active { border: 3px solid #FFD700; transform: scale(1.15); box-shadow: 0 0 12px #FFD700; z-index: 10; }
        .color-drop.water { background: radial-gradient(circle at 30% 30%, #ffffff, #87CEFA); border: 2px solid #B0E0E6; }

        .reset-all-btn { 
            background-color: #FF6347; color: white; border: none; 
            padding: 10px 25px; border-radius: 25px; font-size: 1.1rem;
            cursor: pointer; font-family: 'Jua', cursive;
            box-shadow: 0 4px #c0392b; margin-top: 5px;
        }
        .reset-all-btn:active { transform: translateY(3px); box-shadow: 0 1px #c0392b; }

        /* ë¹„ì»¤ UI */
        .beaker-ui-group {
            position: absolute; display: flex; flex-direction: row; 
            align-items: center; justify-content: center; gap: 4px;
            pointer-events: none; 
            transform: translate(-50%, -50%);
            width: 120px;
        }

        .beaker-label { 
            font-size: 13px; color: #333; font-weight: bold; 
            background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 8px;
            white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .beaker-reset-btn {
            pointer-events: auto; 
            width: 26px; height: 26px;
            background-color: #fff; color: #333; border: 2px solid #FF6347; border-radius: 50%;
            cursor: pointer; font-size: 14px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .beaker-reset-btn:active { transform: scale(0.9); background-color: #FF6347; color: white; }
    </style>
</head>
<body>

<audio id="sfx-pop" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.m4a"></audio>
<audio id="sfx-splash" src="https://assets.mixkit.co/active_storage/sfx/112/112-preview.m4a"></audio>
<audio id="sfx-whoosh" src="https://assets.mixkit.co/active_storage/sfx/1472/1472-preview.m4a"></audio>

<div id="ui-container">
    <div class="info" id="status">ì§„í•œ ìƒ‰ê¹”ì„ ê³¨ë¼ë´! í•˜ìœ¤!</div>
    <div class="palette" id="palette"></div>
    <button class="reset-all-btn" id="resetAllBtn">âœ¨ ëª¨ë‘ ë¹„ìš°ê¸°</button>
</div>

<script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const sfxPop = document.getElementById('sfx-pop');
    const sfxSplash = document.getElementById('sfx-splash');
    const sfxWhoosh = document.getElementById('sfx-whoosh');
    sfxSplash.volume = 0.6;
    function playSound(sound) { sound.currentTime = 0; sound.play().catch(() => {}); }

    // --- ì”¬ ì„¤ì • ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); 
    scene.fog = new THREE.FogExp2(0x87CEEB, 0.02);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    // [ë°˜ì‘í˜• ì¹´ë©”ë¼ ìœ„ì¹˜ ì„¤ì • í•¨ìˆ˜]
    // í™”ë©´ ë¹„ìœ¨ì— ë”°ë¼ ì¹´ë©”ë¼ ê±°ë¦¬ë¥¼ ì¡°ì ˆí•˜ì—¬ í•­ìƒ ëª¨ë“  ë¹„ì»¤ê°€ ë³´ì´ê²Œ í•¨
    function fitCamera() {
        const aspect = window.innerWidth / window.innerHeight;
        // ì„¸ë¡œê°€ ê¸´ í™”ë©´(ëª¨ë°”ì¼)ì¼ìˆ˜ë¡ ë” ë©€ë¦¬(Zê°’ì„ í¬ê²Œ) ì¡ìŒ
        // ê¸°ë³¸ 23ì—ì„œ ë¹„ìœ¨ì— ë”°ë¼ ë” ë©€ì–´ì§€ê²Œ ê³„ì‚°
        const distance = aspect < 1 ? 26 / aspect : 22; 
        
        camera.position.set(0, 8, distance);
        camera.updateProjectionMatrix();
    }

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.outputColorSpace = THREE.SRGBColorSpace; 
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.maxPolarAngle = Math.PI / 1.7; 
    controls.minDistance = 10;
    controls.maxDistance = 45;
    
    // â˜… [í•µì‹¬] ì¹´ë©”ë¼ íƒ€ê²Ÿì„ ë¹„ì»¤ ìœ„ì¹˜ë³´ë‹¤ ì•„ë˜ë¡œ(Y=3.5) ì„¤ì •
    // ì´ë ‡ê²Œ í•˜ë©´ ì¹´ë©”ë¼ê°€ ì•„ë˜ë¥¼ ë³´ê²Œ ë˜ì–´, ë¹„ì»¤ë“¤ì€ í™”ë©´ì˜ 'ìœ„ìª½'ì— ë°°ì¹˜ë¨
    // ì¦‰, ì•„ë˜ìª½ UI ê³µê°„ì„ í™•ë³´í•˜ëŠ” íš¨ê³¼!
    controls.target.set(0, 3.5, 0); 

    // ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ ì„¤ì • ì‹¤í–‰
    fitCamera();

    // --- ì¡°ëª… ---
    scene.add(new THREE.AmbientLight(0xffffff, 0.5)); 
    const sunLight = new THREE.DirectionalLight(0xFFFFFF, 1.0); 
    sunLight.position.set(5, 15, 10);
    sunLight.castShadow = true;
    scene.add(sunLight);

    // --- ë°”ë‹¥ ---
    const planeGeo = new THREE.PlaneGeometry(200, 200);
    const planeMat = new THREE.MeshStandardMaterial({ color: 0x7CAE7C, roughness: 0.8 });
    const plane = new THREE.Mesh(planeGeo, planeMat);
    plane.rotation.x = -Math.PI / 2;
    plane.position.y = -4;
    plane.receiveShadow = true;
    scene.add(plane);

    function createShelf(y) {
        const geo = new THREE.BoxGeometry(13, 0.3, 3.5);
        const mat = new THREE.MeshStandardMaterial({ color: 0xDEB887, roughness: 0.6 });
        const shelf = new THREE.Mesh(geo, mat);
        shelf.position.y = y - 1.4; 
        shelf.receiveShadow = true;
        shelf.castShadow = true;
        scene.add(shelf);
    }
    
    // [ë°°ì¹˜ ìƒí–¥] ì„ ë°˜ ë†’ì´ë¥¼ ë” ë†’ê²Œ ì¡ìŒ
    // 1ì¸µ: 3.5 (UI ìœ„ë¡œ ì™„ì „íˆ ë„ì›€)
    // 2ì¸µ: 8.5
    const Y_BOTTOM_ROW = 3.5;
    const Y_TOP_ROW = 8.5;
    createShelf(Y_BOTTOM_ROW); 
    createShelf(Y_TOP_ROW); 

    // --- ìƒ‰ìƒ ë°ì´í„° ---
    const PIGMENTS = {
        red:    { c:0.0, m:0.95, y:0.95, k:0.05 }, 
        orange: { c:0.0, m:0.60, y:1.00, k:0.0 }, 
        yellow: { c:0.0, m:0.00, y:1.00, k:0.0 },
        green:  { c:0.9, m:0.00, y:0.90, k:0.15 },
        mint:   { c:0.4, m:0.00, y:0.30, k:0.0 },
        sky:    { c:0.6, m:0.10, y:0.00, k:0.0 },
        blue:   { c:1.0, m:0.60, y:0.00, k:0.1 }, 
        navy:   { c:1.0, m:0.90, y:0.20, k:0.4 },
        purple: { c:0.6, m:0.90, y:0.00, k:0.1 }, 
        pink:   { c:0.0, m:0.50, y:0.05, k:0.0 }, 
        brown:  { c:0.3, m:0.65, y:0.90, k:0.4 },
        grey:   { c:0.0, m:0.00, y:0.00, k:0.6 },
        black:  { c:0.0, m:0.00, y:0.00, k:1.0 },
        white:  { c:0.0, m:0.00, y:0.00, k:0.0 },
        water:  { c:0.0, m:0.00, y:0.00, k:0.0, isWater: true }
    };

    const colors = [
        { r:200, g:0, b:0,     id: 'red' },      
        { r:255, g:120, b:0,   id: 'orange' },   
        { r:255, g:210, b:0,   id: 'yellow' },   
        { r:124, g:252, b:0,   id: 'mint' },
        { r:0, g:140, b:0,     id: 'green' },    
        { r:0, g:191, b:255,   id: 'sky' },
        { r:0, g:0, b:180,     id: 'blue' },     
        { r:25, g:25, b:112,   id: 'navy' },
        { r:128, g:0, b:128,   id: 'purple' },   
        { r:255, g:20, b:147,  id: 'pink' },     
        { r:139, g:69, b:19,   id: 'brown' },
        { r:100, g:100, b:100, id: 'grey' },
        { r:20, g:20, b:20,    id: 'black' },
        { r:255, g:255, b:255, id: 'white' },
        { r:240, g:248, b:255, id: 'water' }, 
        { r:240, g:248, b:255, id: 'water' } 
    ];

    let selectedColorData = null;
    const beakers = [];
    const MAX_DROPS = 50; 

    const B_RADIUS = 1.15;
    const glassMaterial = new THREE.MeshPhongMaterial({
        color: 0xffffff, opacity: 0.1, transparent: true, shininess: 100, side: THREE.DoubleSide, depthWrite: false
    });
    const rimMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.4 }); 

    const beakerBodyGeo = new THREE.CylinderGeometry(B_RADIUS, B_RADIUS * 0.95, 3.2, 32, 1, true);
    const beakerBottomGeo = new THREE.CircleGeometry(B_RADIUS * 0.95, 32);
    const rimGeo = new THREE.TorusGeometry(B_RADIUS, 0.05, 16, 48);
    const liquidGeoRaw = new THREE.CylinderGeometry(B_RADIUS * 0.91, B_RADIUS * 0.88, 3.0, 32);
    liquidGeoRaw.translate(0, 1.5, 0); 

    for (let i = 0; i < 8; i++) {
        const beakerGroup = new THREE.Group();
        
        beakerGroup.add(new THREE.Mesh(beakerBodyGeo, glassMaterial));
        const bottom = new THREE.Mesh(beakerBottomGeo, glassMaterial);
        bottom.rotation.x = -Math.PI / 2; bottom.position.y = -1.6; beakerGroup.add(bottom);
        const topRim = new THREE.Mesh(rimGeo, rimMaterial);
        topRim.rotation.x = Math.PI / 2; topRim.position.y = 1.6; beakerGroup.add(topRim);

        const liqMat = new THREE.MeshStandardMaterial({ 
            color: 0xffffff, transparent: true, opacity: 0.96, roughness: 0.25, metalness: 0.0,
            emissive: 0x000000, emissiveIntensity: 0.15 
        });
        const liquid = new THREE.Mesh(liquidGeoRaw, liqMat);
        liquid.position.y = -1.58; 
        liquid.scale.y = 0.001; 
        beakerGroup.add(liquid);

        const uiGroup = document.createElement('div');
        uiGroup.className = 'beaker-ui-group';
        const label = document.createElement('div');
        label.className = 'beaker-label';
        label.innerText = `0`;
        const btn = document.createElement('div');
        btn.className = 'beaker-reset-btn';
        btn.innerHTML = 'ğŸ—‘ï¸'; 
        btn.onclick = (e) => { e.stopPropagation(); playSound(sfxWhoosh); resetBeaker(beakerGroup); };

        uiGroup.appendChild(label); uiGroup.appendChild(btn);
        document.body.appendChild(uiGroup); 

        // [ë°°ì¹˜ ì ìš©] ìƒë‹¨ ìƒìˆ˜ê°’ ì ìš©
        const isTopRow = i >= 4; const col = i % 4;
        beakerGroup.position.x = (col - 1.5) * 2.8; 
        beakerGroup.position.y = isTopRow ? Y_TOP_ROW : Y_BOTTOM_ROW;
        
        beakerGroup.userData = { 
            id: i, drops: [], liquidMesh: liquid, uiGroup: uiGroup, label: label,
            initialRotation: beakerGroup.rotation.clone(),
            wobbleNeed: false
        };
        scene.add(beakerGroup);
        beakers.push(beakerGroup);
    }

    function getMixedColor(drops) {
        if (drops.length === 0) return { r: 1, g: 1, b: 1, a: 0 }; 
        
        let sumC = 0, sumM = 0, sumY = 0, sumK = 0;
        let waterCount = 0;
        drops.forEach(d => {
            const p = PIGMENTS[d.id];
            if (p.isWater) waterCount++;
            else { sumC += p.c; sumM += p.m; sumY += p.y; sumK += p.k; }
        });

        const totalDrops = drops.length;
        const c = sumC / totalDrops; const m = sumM / totalDrops; const y = sumY / totalDrops; const k = sumK / totalDrops;
        let r = 255 * (1 - c) * (1 - k); let g = 255 * (1 - m) * (1 - k); let b = 255 * (1 - y) * (1 - k);
        r = Math.max(0, Math.min(255, r)) / 255; g = Math.max(0, Math.min(255, g)) / 255; b = Math.max(0, Math.min(255, b)) / 255;

        let op;
        if (sumC+sumM+sumY+sumK === 0 && waterCount > 0) op = 0.25; 
        else { const pigmentRatio = (totalDrops - waterCount) / totalDrops; op = 0.8 + (pigmentRatio * 0.2); }
        return { r: r, g: g, b: b, a: op };
    }

    function resetBeaker(beakerGroup) {
        const data = beakerGroup.userData;
        data.drops = [];
        data.liquidMesh.material.color.setRGB(1, 1, 1);
        data.liquidMesh.material.emissive.setHex(0x000000);
        data.liquidMesh.material.opacity = 0;
        data.liquidMesh.scale.y = 0.001;
        data.label.innerText = `0`;
    }

    function updateBeakerUIPosition(beakerGroup) {
        const vector = new THREE.Vector3();
        beakerGroup.localToWorld(vector.set(0, -2.2, 0)); 
        vector.project(camera);
        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
        const ui = beakerGroup.userData.uiGroup;
        ui.style.left = `${x}px`; ui.style.top = `${y}px`;
    }

    const palette = document.getElementById('palette');
    const status = document.getElementById('status');

    colors.forEach((c, i) => {
        const btn = document.createElement('div');
        btn.className = 'color-drop';
        if (i >= 14) btn.classList.add('water');
        else {
            btn.style.backgroundColor = `rgb(${c.r},${c.g},${c.b})`;
            if (c.r > 240 && c.g > 240 && c.b > 240) btn.style.border = '2px solid #ccc';
        }
        btn.onpointerdown = () => {
            playSound(sfxPop); 
            document.querySelectorAll('.color-drop').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedColorData = { ...c };
            if (c.id === 'water') status.innerHTML = "íˆ¬ëª…í•œ ë¬¼! ìƒ‰ì„ ì—°í•˜ê²Œ í•´ì¤˜.";
            else status.innerHTML = "ì„ íƒ ì™„ë£Œ! ë¹„ì»¤ì— ë„£ì–´ë´!";
        };
        palette.appendChild(btn);
    });

    document.getElementById('resetAllBtn').onclick = () => { playSound(sfxWhoosh); beakers.forEach(b => resetBeaker(b)); };

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    window.addEventListener('pointerdown', (e) => {
        if (e.target.closest('#ui-container') || e.target.closest('.beaker-reset-btn')) return;
        if (!selectedColorData) { status.innerHTML = "<span class='highlight'>ìƒ‰ê¹”ì„ ë¨¼ì € ê³¨ë¼ì¤˜!</span>"; return; }

        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(beakers, true);
        if (intersects.length > 0) {
            let targetGroup = intersects[0].object;
            while(targetGroup && !targetGroup.userData.drops) targetGroup = targetGroup.parent;

            if (targetGroup) {
                const data = targetGroup.userData;
                if (data.drops.length < MAX_DROPS) {
                    playSound(sfxSplash); 
                    data.wobbleNeed = true; data.wobbleStartTime = Date.now();
                    data.drops.push({ ...selectedColorData });
                    
                    const mixed = getMixedColor(data.drops);
                    data.liquidMesh.material.color.setRGB(mixed.r, mixed.g, mixed.b);
                    data.liquidMesh.material.emissive.setRGB(mixed.r, mixed.g, mixed.b);
                    data.liquidMesh.material.opacity = mixed.a;

                    const fillRatio = data.drops.length / MAX_DROPS;
                    data.liquidMesh.scale.y = Math.max(0.15, fillRatio); 
                    data.label.innerText = `${data.drops.length}`;
                    status.innerText = "ì˜í–ˆì–´! í•˜ìœ¤!";
                } else {
                    status.innerText = "ê°€ë“ ì°¼ì–´!";
                }
            }
        }
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        const now = Date.now();
        beakers.forEach(b => {
            if(b.userData.wobbleNeed) {
                const elapsed = now - b.userData.wobbleStartTime;
                if (elapsed < 300) { 
                    const intensity = 0.05 * (1 - elapsed / 300);
                    b.rotation.x = b.userData.initialRotation.x + Math.sin(elapsed * 0.05) * intensity;
                } else {
                    b.rotation.copy(b.userData.initialRotation); 
                    b.userData.wobbleNeed = false;
                }
            }
            updateBeakerUIPosition(b);
        });
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        // í™”ë©´ í¬ê¸° ë°”ë€” ë•Œë§ˆë‹¤ ì¹´ë©”ë¼ ê±°ë¦¬ ì¬ì¡°ì •
        fitCamera();
    });
</script>
</body>
</html>
